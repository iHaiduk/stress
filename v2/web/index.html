<html>
<body>

<div id="aggregate"></div>
<div id="rps"></div>

</body>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript"
        src="https://www.google.com/jsapi?autoload={
            'modules':[{
              'name':'visualization',
              'version':'1',
              'packages':['corechart']
            }]
          }"></script>

<script type="text/javascript">

    google.setOnLoadCallback(drawChart);
    var socket = io();
    var results = {
        "aggregate" : [['step', 'max', 'min', 'avg']],
        "rps" : [['step', 'rps']]
    };
    var charts = {};
    var options = {
        "aggregate" : {
            title: 'aggregated metrics',
            curveType: 'none',
            legend: { position: 'bottom' }
        },
        "rps" : {
            title: 'RPS',
            curveType: 'none',
            legend: { position: 'bottom' }
        }
    };

    function init(containerName) {
        var container = document.getElementById(containerName);
        charts[containerName] = new google.visualization.LineChart(container);
    }

    function collectResult(containerName, item) {
        results[containerName].push(item);
    }

    function draw(containerName) {
        var gData = google.visualization.arrayToDataTable(results[containerName]);
        charts[containerName].draw(gData, options[containerName]);
    }

    function drawChart() {

        var result = null;

        socket.on('connect', function (socket) {
            console.log("Connected");
            result = null;
            init('aggregate');
            init('rps');
        });

        socket.on('data', function(msg){

            var item = [msg.step];

            for (var i in msg.aggregated) {
                item.push(parseInt(msg.aggregated[i]) || 0);
            }

            collectResult('aggregate', item);
            collectResult('rps', [msg.step, msg.rps]);

            draw('aggregate');
            draw('rps');
        });


    }
</script>

</html>